<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core" xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                xmlns:adm="http://github.com/adminfaces"
                template="#{layoutMB.template}">

    <ui:define name="metadata">
        <ui:param name="title" value="Chiffre d'affaires"/> <!-- Automatic create breadCrumb and page title when param 'title' is provided. -->

        <style type="text/css">
            .ui-datatable .ui-datatable-header {
                text-align: right !important;
            }

            th.ui-filter-column {
                padding: 5px 2px !important;
            }

            #footer:hover {
                opacity: 1;
            }

            #footer {
                float: right;
                font-size: 12px;
                text-align: right;
                font: bold;
                font-weight: 500;
            }

            .ui-datatable-footer {
                border: none;
            }

            .ui-grid td {
                white-space: nowrap;
                border: none;
            }

        </style>
    </ui:define>

    <ui:define name="description">
        Affiche le chiffre d'affaires des 5 dernières années.
    </ui:define>

    <ui:define name="body">

        <h:form>
            <p:focus context="@form"/>  
            <div class="box box-primary">
                <div class="box-header with-border">
                    <div id="main-buttons" class="hidden-sm hidden-xs">
                        <p:commandButton icon="fa fa-file-pdf-o" action="#{prestationChiffreAffaireBean.PDF()}"
                                         value="PDF" styleClass="btn-primary" ajax="false"
                                         disabled="#{prestationChiffreAffaireBean.listPrest.size() == 0}" >
                            <!--p:dataExporter type="pdf" target="caTable"
                                            fileName="CA-par-an-#{prestationChiffreAffaireBean.anneeDebut}-#{prestationChiffreAffaireBean.anneeFin}" 
                            /-->
                        </p:commandButton>
                        <p:spacer width="5"/>
                        <p:commandButton value="Excel" icon="fa fa-file-excel-o" styleClass="btn-danger"
                                         ajax="false"
                                         disabled="#{prestationChiffreAffaireBean.listPrest.size() == 0}">
                            <p:dataExporter type="xls" target="caTable"
                                            fileName="CA-par-an-#{prestationChiffreAffaireBean.anneeDebut}-#{prestationChiffreAffaireBean.anneeFin}" />

                        </p:commandButton>
                        <p:spacer width="5"/>
                        <p:commandButton value="Recherche" update="@(.ui-dialog)" styleClass="btn-info"
                                         oncomplete="PF('searchDialog').show()" icon="fa fa-search"/>
                    </div>

                    <p:separator/>
                    <p:dataTable id="caTable" widgetVar="caTable" var="code" value="#{prestationChiffreAffaireBean.keyList}">

                        <f:facet name="header">
                            <p:outputLabel for="anneeDebut" style="font-size: 20px" value="Evolution du chiffre d'affaires de " />
                            <p:spacer width="10"/>
                            <p:spinner id="anneeDebut" maxlength="4" style=" width: 80px" value="#{prestationChiffreAffaireBean.anneeDebut}" min="2000" max="2050"/>
                            <p:spacer width="10"/>
                            <p:outputLabel for="anneeFin" style="font-size: 20px" value=" à " />
                            <p:spacer width="10"/>
                            <p:spinner id="anneeFin" maxlength="4" style="width: 80px" value="#{prestationChiffreAffaireBean.anneeFin}" min="2000" max="2050" />
                            <p:spacer width="15"/>
                            <p:commandButton id="brFind" value="OK" icon="fa fa-search"
                                             action="#{prestationChiffreAffaireBean.findByYear(prestationChiffreAffaireBean.anneeDebut,prestationChiffreAffaireBean.anneeFin)}"
                                             process="@form"
                                             update="@form"
                                             styleClass="bg-black btn-primary"
                                             partialSubmit="true"/>
                        </f:facet>

                        <p:columnGroup type="header">
                            <p:row>
                                <p:column style="width:200px;font-size: 16px" rowspan="2" headerText="Prestation" />
                                <p:column style="font-size: 16px" colspan="#{prestationChiffreAffaireBean.yearCount}" headerText="Montant HT" />
                            </p:row>
                            <p:row>
                                <ui:repeat value="#{prestationChiffreAffaireBean.years}" var="year">
                                    <p:column style="" headerText="#{year}" />
                                </ui:repeat>
                            </p:row>
                        </p:columnGroup>

                        <p:column style="width:300px;font:bold">
                            <h:outputText value="#{prestationChiffreAffaireBean.getLibellePrestationParCode(code)}" />
                        </p:column>

                        <p:columns style="text-align:right" value="#{prestationChiffreAffaireBean.years}" var="year">
                            <h:outputText class="align-right" value="#{prestationChiffreAffaireBean.getMontantPrest(year, code)}">
                                <f:convertNumber locale="fr_FR" />
                            </h:outputText>
                        </p:columns>

                        <p:columnGroup type="footer">
                            <p:row >
                                <p:column footerText="TOTAUX:" />
                                <p:columns style="text-align: right; font-size: 16px"  value="${prestationChiffreAffaireBean.years}" var="annee">
                                    <f:facet name="footer">
                                        <h:outputText  value="#{prestationChiffreAffaireBean.montantTotalParAn(annee)}">
                                            <f:convertNumber locale="fr_FR" />
                                        </h:outputText>
                                    </f:facet>
                                </p:columns>
                            </p:row>
                        </p:columnGroup>

                    </p:dataTable>
                </div>
            </div>
        </h:form>

        <p:dialog header="Exportation PDF" widgetVar="pdfDialog" appendTo="@(body)"
                  responsive="true" draggable="false" styleClass="box-success">
            <h:form>
                <iframe name="receipt" height="600" id="theIFrame" width="100%"
                        src="http://localhost:8080/sysaide/CA-par-an-#{prestationChiffreAffaireBean.anneeDebut}-#{prestationChiffreAffaireBean.anneeFin}.pdf" />
            </h:form>
        </p:dialog>

        <p:dialog header="Choisir une période" widgetVar="searchDialog" appendTo="@(body)"
                  responsive="true" draggable="false" styleClass="box-success">
            <h:form>
                <p:panelGrid columns="2" style="border: none;">
                    <p:outputLabel for="anneeDebut" value="De"/>
                    <p:outputLabel for="anneeFin" value="A"/>
                    <p:spinner id="anneeDebut" maxlength="4" style=" width: 80px" value="#{prestationChiffreAffaireBean.anneeDebut}" min="2000" max="2050"/>


                    <p:spinner id="anneeFin" maxlength="4" style="width: 80px" value="#{prestationChiffreAffaireBean.anneeFin}" min="2000" max="2050" />

                </p:panelGrid>
                <p:separator/>
                <p:commandButton value="OK" update="@form @(.ui-datatable, .ui-tooltip)" icon="fa fa-check"
                                 ignoreAutoUpdate="true" styleClass="btn-primary" oncomplete="PF('searchDialog').hide()"/>
                <p:separator/>
            </h:form>
        </p:dialog>

    </ui:define>

</ui:composition>
